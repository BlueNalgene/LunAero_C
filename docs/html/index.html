<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LunAero_C: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">LunAero_C
   </div>
   <div id="projectbrief">A C++ Control and GUI for the LunAero moon tracking robot</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">LunAero_C Documentation</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="image">
<img src="https://i.imgur.com/jRGf8h6h.jpg" alt="The first fully automated lunar bird tracker" title="The first fully automated lunar bird tracker"/>
</div>
<h1>The LunAero Project</h1>
<p>LunAero is a hardware and software project using OpenCV to automatically track birds as they migrate in front of the moon. This repository contains information related to the construction of LunAero hardware and the software required for running the moon tracking program. Bird detection has "migrated" to a new repository at <a href="https://github.com/BlueNalgene/CPP_Birdtracker">https://github.com/BlueNalgene/CPP_Birdtracker</a>.</p>
<p>Created by , working in the lab of -S-Bridge.</p>
<h1>LunAero_C vs. LunAero</h1>
<p>The LunAero_C repository is an updated version of the LunAero robotics software. The previous implementation (archived at <a href="https://github.com/BlueNalgene/LunAero">https://github.com/BlueNalgene/LunAero</a>) was a Python 3 script which operated hardware based on the ODROID N2 single board computer. This updated version is C++ code designed for the Raspberry Pi v3, and includes many improvements, additional features, and is generally more mature code.</p>
<h2>Hardware Recommendations</h2>
<ul>
<li>Raspberry Pi v3</li>
<li>USB 3 drive with transfer rate of at least 200 MB/s</li>
<li>Raspberry Pi camera module</li>
<li>Motors (2)</li>
<li>TB6612FNG motor controller</li>
<li>1/4" Acrylic (about 18"x24")
- 1/8" Acetal (about 3"x3")</li>
<li>Screws and Wires</li>
</ul>
<p>This new version of LunAero requires a Raspberry Pi v3 single board computer. We recommend running this on the Raspbian operating system, although most linux distros should work fine (untested, so use at your own risk). The reason we require v3 hardware is the addition of USB 3 slots over previous versions of the Raspberry Pi which only included USB 2.</p>
<p>A USB 3 drive with a minimum real transfer rate of 200 MB/s is required for this hardware. Due to the large size of long term high quality video recorded by LunAero, this transfer rate is a must. You should check that your drive actually performs at this speed. Some hard disk manufacturers might claim transfer speeds of "up to" the USB 3 maximum rate (625 MB/s) without actually being able to get anywhere near this speed.</p>
<p>Unsure of your hard drive transfer rate? On linux systems you can use this command to test it: </p><div class="fragment"><div class="line">cat /dev/zero | pv &gt; /path/to/your/drive/junkfile</div></div><!-- fragment --><p> The real-time transfer rate is printed on the terminal. Press <code>ctrl</code>+<code>c</code> to stop the script and use: </p><div class="fragment"><div class="line">rm /path/to/your/drive/junkfile</div></div><!-- fragment --><p> to remove the junkfile you created.</p>
<p>Whatever you do, <b>avoid storing video on the SD card!</b> Even if you have a giant SD card with a ton of space, the technology underlying the SD card is fragile for frequent writes and rewrites. Saving large videos to your SD card is a good way to damage it, corrupting your OS. So <b>avoid storing video on the SD card!</b></p>
<p>This installation uses a Raspberry Pi camera module. Currently, there is no implementation for USB cameras and no support for this is planned. The software makes use of Raspbian's <code>raspivid</code> command to handle recording video. We have tried v1 and v2 Raspberry Pi camera modules and had no problems. Fancy cameras such as the IR camera module have not been tested.</p>
<p>A TB6612FNG breakout board is required to control two motors. If you don't have one of these laying around (we made our own board in house), you can get them from Sparkfun <a href="https://www.sparkfun.com/products/14451">https://www.sparkfun.com/products/14451</a>.</p>
<p>This hardware implementation requires two low speed/high torque 5V motors. We used 0.5 rpm motors purchased from Amazon (uxcell DC 5V 0.5RPM Worm Gear Motor 6mm Shaft High Torque Turbine Reducer). If you change motors, be sure that the CAD designs match the drill holes required for the motor to attach to the plastic.</p>
<p>This project include designs for plastic parts to be cut from 1/4"
acrylic plastic and 1/8" acetal plastic. You can change these materials if you like. E.g. it would be reasonable to swap the acetal for some of the 1/4" acyrlic if you are low on funds. HOWEVER, the acetal makes much better gears and will give you much smoother motion.</p>
<p>Hardware updates are planned, but the current version uses most of the original design, which can be found at <a href="https://osf.io/k6nfs/">https://osf.io/k6nfs/</a> .</p>
<h2>Using the 2D CAD files</h2>
<p>The CAD files in the 2D CAD folder are used to construct parts for LunAero including gears and mounting brackets. The parts are designed to be cut on a laser CNC machine. They can also be used as templates for cutting on a band saw or using another CNC machine.</p>
<p>The units are in mm for all parts.</p>
<p>Part files can be found at: <a href="https://osf.io/k6nfs/">https://osf.io/k6nfs/</a> .</p>
<p>Assembly information can be found at: <a href="https://osf.io/y2n3j/">https://osf.io/y2n3j/</a> .</p>
<h2>Software Install Instructions</h2>
<h3>Option 1: Compile this Repository</h3>
<p>To follow my instructions, you need to use the Linux terminal, where you can copy and paste the following scripts. To open the Linux terminal, press <code>ctrl</code>+<code>alt</code>+<code>t</code> or click the icon on the Raspbian desktop.</p>
<p>When you install this for the first time on to a 'blank' Raspberry Pi, you will need certain repositories installed to make it. Use the following command in your terminal (Note: this looks way more daunting than it really is, your Raspberry Pi will have most of these installed with a default Raspbian configuration):</p>
<div class="fragment"><div class="line">sudo apt update</div><div class="line">sudo apt -y install git libc6-dev libgcc-8-dev libraspberrypi0 wiringpi \</div><div class="line">libstdc++-8-dev libgtk-3-dev libpango1.0-dev libatk1.0-dev libcairo2-dev \</div><div class="line">libgdk-pixbuf2.0-dev libglib2.0-dev libopencv-shape-dev \</div><div class="line">libopencv-stitching-dev libopencv-superres-dev libopencv-videostab-dev \</div><div class="line">libopencv-contrib-dev libopencv-video-dev libopencv-viz-dev \</div><div class="line">libopencv-calib3d-dev libopencv-features2d-dev libopencv-flann-dev \</div><div class="line">libopencv-objdetect-dev libopencv-ml-dev libopencv-highgui-dev \</div><div class="line">libopencv-videoio-dev libopencv-imgcodecs-dev libopencv-photo-dev \</div><div class="line">libopencv-imgproc-dev libopencv-core-dev libnotify-dev libc6 libglib2.0-0 \</div><div class="line">libx11-6 libxi6 libxcomposite1 libxdamage1 libxfixes3 libatk-bridge2.0-0 \</div><div class="line">libxkbcommon0 libwayland-cursor0 libwayland-egl1 libwayland-client0 \</div><div class="line">libepoxy0 libharfbuzz0b libpangoft2-1.0-0 libfontconfig1 libfreetype6 \</div><div class="line">libxinerama1 libxrandr2 libxcursor1 libxext6 libthai0 libfribidi0 \</div><div class="line">libpixman-1-0 libpng16-16 libxcb-shm0 libxcb1 libxcb-render0 libxrender1 \</div><div class="line">zlib1g libmount1 libselinux1 libffi6 libpcre3 libtbb2 libhdf5-103 libsz2 \</div><div class="line">libjpeg62-turbo libtiff5 libvtk6.3 libgl2ps1.4 libglu1-mesa libsm6 \</div><div class="line">libice6 libxt6 libgl1 libtesseract4 liblept5 libdc1394-22 libgphoto2-6 \</div><div class="line">libgphoto2-port12 libavcodec58 libavformat58 libavutil56 libswscale5 \</div><div class="line">libavresample4 libwebp6 libgdcm2.8 libilmbase23 libopenexr23 libgdal20 \</div><div class="line">libdbus-1-3 libatspi2.0-0 libgraphite2-3 libexpat1 libuuid1 libdatrie1 \</div><div class="line">libxau6 libxdmcp6 libblkid1 libatomic1 libaec0 libzstd1 liblzma5 libjbig0 \</div><div class="line">libbsd0 libglvnd0 libglx0 libgomp1 libgif7 libopenjp2-7 libraw1394-11 \</div><div class="line">libusb-1.0-0 libltdl7 libexif12 libswresample3 libvpx5 libwebpmux3 \</div><div class="line">librsvg2-2 libzvbi0 libsnappy1v5 libaom0 libcodec2-0.8.1 libgsm1 \</div><div class="line">libmp3lame0 libopus0 libshine3 libspeex1 libtheora0 libtwolame0 \</div><div class="line">libvorbis0a libvorbisenc2 libwavpack1 libx264-155 libx265-165 \</div><div class="line">libxvidcore4 libva2 libxml2 libbz2-1.0 libgme0 libopenmpt0 \</div><div class="line">libchromaprint1 libbluray2 libgnutls30 libssh-gcrypt-4 libva-drm2 \</div><div class="line">libva-x11-2 libvdpau1 libdrm2 libcharls2 libjson-c3 libarmadillo9 \</div><div class="line">libproj13 libpoppler82 libfreexl1 libqhull7 libgeos-c1v5 libepsilon1 \</div><div class="line">libodbc1 odbcinst1debian2 libkmlbase1 libkmldom1 libkmlengine1 \</div><div class="line">libkmlxsd1 libkmlregionator1 libxerces-c3.2 libnetcdf13 libhdf4-0-alt \</div><div class="line">libogdi3.2 libgeotiff2 libpq5 libdapclient6v5 libdapserver7v5 \</div><div class="line">libdap25 libspatialite7 libcurl3-gnutls libfyba0 libmariadb3 libssl1.1 \</div><div class="line">libsystemd0 libudev1 libsoxr0 libcroco3 libogg0 libicu63 libmpg123-0 \</div><div class="line">libvorbisfile3 libp11-kit0 libidn2-0 libunistring2 libtasn1-6 libnettle6 \</div><div class="line">libhogweed4 libgmp10 libgcrypt20 libgssapi-krb5-2 libarpack2 libsuperlu5 \</div><div class="line">libnss3 libnspr4 liblcms2-2 libgeos-3.7.1 libpopt0 libminizip1 \</div><div class="line">liburiparser1 libkmlconvenience1 libldap-2.4-2 libsqlite3-0 \</div><div class="line">libnghttp2-14 librtmp1 libssh2-1 libpsl5 libkrb5-3 libk5crypto3 \</div><div class="line">libcom-err2 liblz4-1 libgpg-error0 libkrb5support0 libkeyutils1 \</div><div class="line">libgfortran5 libsasl2-2 libblas3 </div></div><!-- fragment --><p>Next, use <code>git</code> to pull this repository. I recommend saving it to a location to makes sense, so in the following example, I am pulling it to the <code>Documents</code> folder in the Raspberry Pi home directory. Once the LunAero <code>git</code> repository is pulled, you can compile it. To do this, execute the lines in the terminal:</p>
<div class="fragment"><div class="line">cd /home/pi/Documents</div><div class="line">git clone https://github.com/BlueNalgene/LunAero_C.git</div><div class="line">cd LunAero_C</div></div><!-- fragment --><p>This script downloads the everything you need to compile the program from this <code>git</code> repository. Once you have the repository on your Raspberry Pi and have installed all of the relevant packages from the <code>apt</code> command above, enter the LunAero_C folder, and issue the following command:</p>
<div class="fragment"><div class="line">make</div></div><!-- fragment --><p>The <code>make</code> command follows the instructions from the <code>Makefile</code> to compile your program. If you ever make changes to the source material, remember to edit the <code>Makefile</code> to reflect changes to the packages used or the required C++ files. If <code>make</code> runs correctly, your terminal will print some text that looks like <code>g++ blah blah -o LunAero_Moontracker</code> spanning a few lines. If the output is significantly longer than that and includes words like ERROR or WARNING, something may have gone wrong, and you should read the error messages to see if something needs to be fixed.</p>
<h3>Option 2: Custom Raspbian Boot Image</h3>
<h3>Option 3 (experimental): Download a Pre-Compiled Binary Release</h3>
<h2>Running LunAero</h2>
<p>Hooray! You compiled a file called <code>LunAero_Moontracker</code>. When you are ready to run the program, you can type the command: </p><div class="fragment"><div class="line">/path/to/LunAero_C/LunAero_Moontracker</div></div><!-- fragment --><p> and the program will run. Alternatively, you can create a desktop icon by copying the file <code>execution_script/C_LunAero_Moontracker</code> from this <code>git</code> repository to your desktop. Note that this script assumes you pulled this <code>git</code> repository to the Documents folder, so you will need to edit the link in the file if you installed things in another location. We recommend the following steps to run the program well:</p>
<h3>Edit the Settings</h3>
<p>A file called <code>settings.cfg</code> has been provided to give the user the ability to modify settings without needing to recompile. Before running, LunAero for the first time, it is prudent to check that you are happy with the default settings. This is especially true for the General Settings at to top of the file.</p>
<p>You will likely need to edit the <code>DRIVE_NAME</code> setting. This should be the name you have assigned to the USB drive you are saving video to. The default is <code>MOON1</code>. This means that the program will try to save video to the drive located at <code>/media/$USER/MOON1/</code>. The program won't work if you have this setting incorrect.</p>
<h3>Time Confirmation</h3>
<p>Before you run LunAero, you should confirm that the date and time of your system is correct. This is a very important step since LunAero saves videos based on the system time, and during analysis, an accurate time stamp is necessary. We recommend single second accuracy for of your system time prior to starting. You should also check that your Raspberry Pi is configured for the correct timezone for the location you are operating in. The most reliable way to check these values on Linux is to open a terminal and use:</p>
<div class="fragment"><div class="line">timedatectl</div></div><!-- fragment --><p>The Raspberry Pi v3 automatically updates the system time when connected to the internet. If you are somewhere without access to the internet (out birding in the middle of nowhere maybe), you will need to update the time and date manually. To set the date to July 20th, 1969 at 10:56:20 pm (The official time that Neil Armstrong stepped on the moon), you would use:</p>
<div class="fragment"><div class="line">sudo date +%Y%m%d -s &quot;19690720&quot;</div><div class="line">sudo date +%T -s &quot;22:56:20&quot;</div></div><!-- fragment --><p>To set the timezone on your Raspberry Pi, you need to enter the config screen, select "Localization Options", and "Change Timezone". To edit the config, use the Raspberry Pi config tool from the terminal with:</p>
<div class="fragment"><div class="line">sudo raspi-config</div></div><!-- fragment --><h3>Manual Adjustment Mode</h3>
<p>Once you have confirmed the time is correct, run the program. Upon startup, you will enter "manual mode". In this mode, you are able to adjust the direction your scope is pointing and a few camera settings. In "manual mode", the bottom center of the screen includes a preview window overlayed on the GUI which shows what the camera sees like a viewfinder.</p>
<p>Take the following steps:</p>
<ul>
<li>Find the moon. Use the arrow buttons on the screen with the mouse or the arrow buttons on your keyboard to move the scope up, down, left, and right to find the moon. If you are having a hard time finding the moon, we recommend tilting and rotating the hardware while the motors are NOT moving to find approximately the correct left-right direction you should be pointing the scope. Then move up or down from that position. It is easier to find the moon if your scope is zoomed out. You can always zoom in once you have found the correct position.</li>
<li>Adjust the zoom of your scope such that the moon fills as much of the preview window as reasonably possible. Do not over zoom such that the edge of the moon appears cut off.</li>
<li>Adjust the brightness of the image by using the ISO and Shutter Speed buttons (or associated keyboard keys), and pass these commands to the camera. The ISO button cycles through the available ISO settings of the Raspberry Pi camera. Your options are 100, 200, 400, and 800. For clear nights, 100 will likely be the best setting. The shutter speed/exposure buttons (pluses and minuses) change the shutter speed. The buttons with a double plus or minus raise the and lower the settings to a greater degree than the single buttons. For a darker image, lower the setting, for a brighter image, raise the setting. None of these buttons update the image in the viewfinder. To use the settings, you must press the "Reissue Camera Command".</li>
<li>Check that LunAero likes your settings.<ul>
<li>The value next to "FOCUS VAL" is the calculated focus quality of your image. You must adjust the focus of your scope to influence it. For best results, attempt to maximize this value.</li>
<li>If your image on the screen is determined by the software to be too bright, a message "TOO BRIGHT!" will appear. Adjust your camera settings based on the instructions in the previous step to make this warning disappear.</li>
</ul>
</li>
<li>Finally, perform any last minute adjustments on the position. The moon should be completely within the preview window, not touching the edge. If you are satisfied with the image...</li>
<li>Press the "▶" button or the <code>Enter</code> key.</li>
</ul>
<h3>Automatic Mode</h3>
<p>Once you are happy with the settings, and pressed <code>Enter</code> to run automatic mode, just step away. Watch with joy and wonder as the scope automatically follows the moon as it moves across the sky. LunAero is recording everything that happens in view of the scope now. You can walk away from it and it will continue recording. Be sure to check that the weather is good and you are in a secure location. Members of the LunAero team are not responsible for anything that happens to your scope if left outside during inclement weather or sticky fingers.</p>
<h2>Viewing the Video Output</h2>
<p>LunAero saves video data to folders on your output USB drive with the following formula: <code>/media/$USER/DRIVE_NAME/YYYYMMDDHHmmSS/*.h264</code> These output files are raw video footage not in a standard "container". You need special codecs to view the video. We recommend the program VLC (<a href="https://www.videolan.org/vlc/">https://www.videolan.org/vlc/</a>) for easiest use. This is an open-source program available for all OS's. If you would like to view videos on your Raspberry Pi, use the following commands to install it:</p>
<div class="fragment"><div class="line">sudo apt update</div><div class="line">sudo apt -y install vlc</div></div><!-- fragment --><h2>When Something Goes Wrong</h2>
<p>Something always goes wrong. It is the way of things. When something inevitably does go wrong with LunAero program, you should first check the logs. If the setting <code>DEBUG_COUT</code> in <code>settings.cfg</code> is set to <code>true</code> the program will attempt to save a log file in the same directory where the videos are saved for each run. This is very detailed, so searching for keywords like <code>WARNING</code> and <code>ERROR</code> are suggested.</p>
<h3>Something Went Wrong... and I can't find a log file</h3>
<p>If there is no log file saved where you would expect it and you have checked that your debug settings are correct, there may have been a problem when writing the log file. Did you see a little notification pop up near the top right of the screen? If you see one of those, it means there was a problem before the log file could be written. Check that you have the correct drive name saved to <code>DRIVE_NAME</code> in the settings. Check to see if the path looks correct. In terminal type</p>
<div class="fragment"><div class="line">ls /media/pi/</div></div><!-- fragment --><p> In the output you should see <code>DRIVE_NAME</code>. If you also see something which looks like <code>DRIVE_NAME</code>_1, then something went wrong mounting the drive. Safely eject and disconnect all drives on the Raspberry Pi. Run the <code>ls</code> command again. If you still see <code>DRIVE_NAME</code> variants WITH THE DRIVE NOT CONNECTED, you need to remove them.</p>
<div class="fragment"><div class="line">sudo rm -r /path/to/offending/drive</div></div><!-- fragment --><p>Be careful with that command. If drives are still connected, you risk data loss by using it. Once the offending false mount points are removed, try connecting your drive again.</p>
<p>This problem usually occurs when drives are incorrectly removed and re-mounted. Linux is very persnickety when it comes to mounting drives. Be sure to eject prior to disconnecting a drive if the Raspberry Pi is running. It is best to have the power disconnected any time you want to remove or add a drive.</p>
<h3>Something Went Wrong...and it isn't listed here</h3>
<p>If you need help, raise an Issue on this <code>git</code> repository with descriptive information so the package maintainer can help you.</p>
<h2>Bird Detection Software</h2>
<p>As of June 21st, 2019, the original Python software for tracking birds in video of the moon has been migrated to a new repository at <a href="https://github.com/BlueNalgene/Birdtracker_LunAero,">https://github.com/BlueNalgene/Birdtracker_LunAero,</a> although work on this version has been discontinued in favor of C++. The new version may be found at <a href="https://github.com/BlueNalgene/CPP_Birdtracker">https://github.com/BlueNalgene/CPP_Birdtracker</a> .</p>
<h2>What if I Want to Play with the Source Code?</h2>
<p>The source code is documented with the <code>Doxygen</code> standard. Every function and most variables are heavily commented to make it easy for you. You can view the documentation online by going to: <a href="https://bluenalgene.github.io/LunAero_C/html/index.html">https://bluenalgene.github.io/LunAero_C/html/index.html</a> . </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
